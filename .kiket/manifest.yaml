model_version: "1.0"
extension:
  sdk: ruby
  id: dev.kiket.ext.twilio
  name: Twilio SMS & Voice Notifications
  version: 1.0.0
  description: Send SMS, MMS, and voice notifications using Twilio with built-in rate limiting and opt-in management
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-twilio
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env.KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - issue.transitioned
    - issue.assigned
    - workflow.sla_breach
    - external.webhook.status_callback
  permissions:
    - issues:read
    - users:read
    - notifications:write
  capabilities:
    - notifications
    - sms
    - voice
    - rate-limiting
    - opt-in-management
    - external-webhook
  hooks:
    - event: issue.transitioned
      template: transition_sms
      timeout: 5000
      retries: 1
      description: Trigger notifications on issue state transitions
    - event: issue.assigned
      template: issue_assigned_sms
      timeout: 5000
      retries: 1
      description: Notify users when assigned to issues
    - event: workflow.sla_breach
      template: sla_breach_sms
      timeout: 5000
      retries: 2
      description: Alert on-call teams of SLA violations
    - event: external.webhook.status_callback
      timeout: 10000
      retries: 0
      description: Receive delivery status callbacks from Twilio
  contributes:
    commands:
      - command: twilio.sendSMS
        title: Send SMS Notification
        description: Send an SMS notification to a phone number
        category: Notifications
        icon: bi-phone
        keywords: ["sms", "text", "phone", "notify"]
        handler:
          type: extension_event
          event: twilio.sendSMS
      - command: twilio.sendVoice
        title: Make Voice Call
        description: Initiate a voice call with text-to-speech message
        category: Notifications
        icon: bi-telephone
        keywords: ["voice", "call", "phone", "notify"]
        handler:
          type: extension_event
          event: twilio.sendVoice
      - command: twilio.manageOptIn
        title: Manage SMS Opt-In
        description: View and update user opt-in status for SMS notifications
        category: Settings
        icon: bi-shield-check
        keywords: ["opt-in", "consent", "sms", "preferences"]
        handler:
          type: extension_event
          event: twilio.manageOptIn
  configuration:
    # Authentication - org-wide credentials (shared across all projects)
    TWILIO_ACCOUNT_SID:
      type: string
      secret: true
      required: true
      scope: extension
      label: Account SID
      description: Twilio Account SID
    TWILIO_AUTH_TOKEN:
      type: string
      secret: true
      required: true
      scope: extension
      label: Auth Token
      description: Twilio Auth Token
    TWILIO_PHONE_NUMBER:
      type: string
      required: true
      scope: extension
      label: Phone Number
      description: Twilio phone number for sending SMS (e.g., +1234567890)
    # Rate Limiting
    RATE_LIMIT_PER_MINUTE:
      type: integer
      default: "10"
      description: Maximum number of messages per minute
    REQUIRE_OPT_IN:
      type: boolean
      default: "true"
      description: Require user opt-in before sending notifications
    DEFAULT_COUNTRY_CODE:
      type: string
      default: "US"
      description: Default country code for phone number parsing
    ENABLE_DELIVERY_TRACKING:
      type: boolean
      default: "true"
      description: Enable delivery status tracking via webhooks
    RETRY_ATTEMPTS:
      type: integer
      default: "3"
      description: Number of retry attempts for failed deliveries
    TIMEOUT_SECONDS:
      type: integer
      default: "30"
      description: Request timeout in seconds
    # Rich Configuration - SMS Templates
    issue_assigned_sms:
      type: template
      editor: template
      language: liquid
      label: Issue Assigned SMS
      description: SMS message sent when assigned to an issue
      default: |
        [Kiket] You've been assigned to: {{ issue.title }}. Priority: {{ issue.priority }}. View: {{ issue.url }}
      variables:
        - name: issue
          type: object
          properties:
            - { name: id, type: number }
            - { name: title, type: string }
            - { name: priority, type: string }
            - { name: url, type: string }
      validation:
        max_length: 160
        required_variables:
          - issue.title
    sla_breach_sms:
      type: template
      editor: template
      language: liquid
      label: SLA Breach SMS
      description: Urgent SMS for SLA violations
      default: |
        [URGENT] SLA Breach: {{ issue.title }}. Policy: {{ sla.policy_name }}. Exceeded by {{ sla.exceeded_by }}. Action required!
      variables:
        - name: issue
          type: object
          properties:
            - { name: title, type: string }
            - { name: url, type: string }
        - name: sla
          type: object
          properties:
            - { name: policy_name, type: string }
            - { name: exceeded_by, type: string }
      validation:
        max_length: 160
        required_variables:
          - issue.title
          - sla.policy_name
    transition_sms:
      type: template
      editor: template
      language: liquid
      label: Transition Notification SMS
      description: SMS for issue state changes
      default: |
        [Kiket] Issue "{{ issue.title }}" moved from {{ transition.from }} to {{ transition.to }}.
      variables:
        - name: issue
          type: object
          properties:
            - { name: title, type: string }
        - name: transition
          type: object
          properties:
            - { name: from, type: string }
            - { name: to, type: string }
      validation:
        max_length: 160
  # Setup Wizard - guides users through extension configuration
  setup:
    # Step 1: Twilio Credentials
    - secrets:
        title: Connect to Twilio
        description: Enter your Twilio account credentials
        required: true
        scope: extension
        help_url: https://www.twilio.com/docs/iam/credentials/api
        collect:
          - TWILIO_ACCOUNT_SID
          - TWILIO_AUTH_TOKEN

    # Step 2: Phone Number Configuration
    - configure:
        title: Configure Phone Number
        description: Set up your Twilio phone number for sending SMS
        scope: extension
        fields:
          - key: TWILIO_PHONE_NUMBER
            type: text
            label: Twilio Phone Number
            description: Your Twilio phone number for sending SMS (e.g., +1234567890)
            placeholder: "+1234567890"
            required: true

    # Step 3: Test Connection
    - test:
        title: Test Connection
        description: Verify your Twilio credentials are working correctly
        action: twilio.validateCredentials
        successMessage: Successfully connected to Twilio!
        required: false

    # Step 4: Webhook URL Info (for delivery status callbacks)
    - info:
        title: Setup Complete
        description: Your Twilio integration is ready
        scope: installation
        content: |
          ## You're all set!

          Your Twilio integration is now configured. Here's what happens next:

          - **SMS notifications** will be sent from your configured phone number
          - **Delivery status** will be tracked via webhooks (if enabled)

          ### Webhook URL for Status Callbacks

          Configure this URL in your Twilio console to receive delivery status updates.
          You can find the webhook URL in the extension configuration page after setup.

          ### Tips

          - Use E.164 format for phone numbers (+1234567890)
          - Enable delivery tracking to monitor message status
          - Set up opt-in management for compliance
        links:
          - label: Twilio Console
            url: https://console.twilio.com/
            icon: box-arrow-up-right
          - label: Kiket Documentation
            url: https://docs.kiket.dev/extensions/twilio
            icon: book

  custom_data:
    permissions:
      - module: dev.kiket.ext.twilio.deliveries
        operations: [read, write]
  assets:
    icon: ./public/icon.svg
  hosting: internal
