model_version: "1.0"
extension:
  id: twilio-notifications
  name: Twilio SMS & Voice Notifications
  version: 1.0.0
  description: Send SMS, MMS, and voice notifications using Twilio with built-in rate limiting and opt-in management
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-twilio
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env:KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - issue.transitioned
    - issue.assigned
    - workflow.sla_breach
  permissions:
    - issues:read
    - users:read
    - notifications:write
  capabilities:
    - notifications
    - sms
    - voice
    - rate-limiting
    - opt-in-management
  hooks:
    - event: issue.transitioned
      timeout: 5000
      retries: 1
      description: Trigger notifications on issue state transitions
    - event: issue.assigned
      timeout: 5000
      retries: 1
      description: Notify users when assigned to issues
    - event: workflow.sla_breach
      timeout: 5000
      retries: 2
      description: Alert on-call teams of SLA violations
  contributes:
    commands:
      - command: twilio.sendSMS
        title: Send SMS Notification
        description: Send an SMS notification to a phone number
        category: Notifications
        icon: bi-phone
        keywords: ["sms", "text", "phone", "notify"]
        handler:
          type: extension_event
          event: twilio.sendSMS
      - command: twilio.sendVoice
        title: Make Voice Call
        description: Initiate a voice call with text-to-speech message
        category: Notifications
        icon: bi-telephone
        keywords: ["voice", "call", "phone", "notify"]
        handler:
          type: extension_event
          event: twilio.sendVoice
      - command: twilio.manageOptIn
        title: Manage SMS Opt-In
        description: View and update user opt-in status for SMS notifications
        category: Settings
        icon: bi-shield-check
        keywords: ["opt-in", "consent", "sms", "preferences"]
        handler:
          type: extension_event
          event: twilio.manageOptIn
  configuration:
    RATE_LIMIT_PER_MINUTE:
      type: integer
      default: "10"
      description: Maximum number of messages per minute
    REQUIRE_OPT_IN:
      type: boolean
      default: "true"
      description: Require user opt-in before sending notifications
    DEFAULT_COUNTRY_CODE:
      type: string
      default: "US"
      description: Default country code for phone number parsing
    ENABLE_DELIVERY_TRACKING:
      type: boolean
      default: "true"
      description: Enable delivery status tracking via webhooks
    RETRY_ATTEMPTS:
      type: integer
      default: "3"
      description: Number of retry attempts for failed deliveries
    TIMEOUT_SECONDS:
      type: integer
      default: "30"
      description: Request timeout in seconds

deployment:
  runtime: cloud_run
  region: ${KIKET_REGION:-europe-west1}
  image: ${TWILIO_IMAGE:-europe-west1-docker.pkg.dev/kiket-471917/kiket-extensions/kiket-ext-twilio:latest}
  resources:
    cpu: "1"
    memory: "512Mi"
    concurrency: 10
  min_instances: 0
  max_instances: 10
  vpc:
    connector: ${KIKET_VPC_CONNECTOR}
    egress: all-traffic
  secret_keys:
    - KIKET_WEBHOOK_SECRET
    - TWILIO_ACCOUNT_SID
    - TWILIO_AUTH_TOKEN
    - TWILIO_PHONE_NUMBER
  env:
    RACK_ENV: production
    PORT: "9393"
